import numpy as np
from NPAHierarchy import NPAHierarchy  # å¯¼å…¥ä½ çš„ NPA å‡½æ•°ï¼ˆç¡®ä¿æ–‡ä»¶åä¸€è‡´ï¼‰


def test_npa_hierarchy():
    """æµ‹è¯• NPAHierarchy å‡½æ•°çš„æ­£ç¡®æ€§å’Œé²æ£’æ€§"""
    test_cases = [
        # ç”¨ä¾‹ 1ï¼šé‡å­å¯è¡Œå…³è”ï¼ˆCHSH æ¸¸æˆçš„é‡å­æœ€ä¼˜å…³è”ï¼ŒK=2 å±‚çº§å¯è¡Œï¼‰
        {
            "name": "CHSH é‡å­å…³è”ï¼ˆK=2ï¼‰",
            "cg": np.array([
                [0, 0, 0],  # ç¬¬ä¸€è¡Œï¼šBob è¾¹ç¼˜åˆ†å¸ƒï¼ˆ[1, p(b1), p(b2)]ï¼‰
                [0, 1, 1],  # ç¬¬äºŒè¡Œï¼šAlice æµ‹é‡ 1 çš„è”åˆåˆ†å¸ƒï¼ˆp(a1), p(a1b1), p(a1b2)ï¼‰
                [0, 1, -1]  # ç¬¬ä¸‰è¡Œï¼šAlice æµ‹é‡ 2 çš„è”åˆåˆ†å¸ƒï¼ˆp(a2), p(a2b1), p(a2b2)ï¼‰
            ]),
            "desc": [2, 2, 2, 2],  # [OA=2, OB=2, MA=2, MB=2]ï¼š2ç»“æœã€2æµ‹é‡è®¾ç½®
            "k": 2,
            "expected": 1.0,  # é¢„æœŸè¿”å› 1ï¼ˆæ»¡è¶³ NPA æ¡ä»¶ï¼‰
        },
        # ç”¨ä¾‹ 2ï¼šç»å…¸å…³è”ï¼ˆCHSH æ¸¸æˆçš„ç»å…¸æœ€ä¼˜å…³è”ï¼ŒK=1 å±‚çº§å¯è¡Œï¼‰
        {
            "name": "CHSH ç»å…¸å…³è”ï¼ˆK=1ï¼‰",
            "cg": np.array([
                [1.0, 0.5, 0.5],
                [0.5, 0.5, 0.0],
                [0.5, 0.0, 0.5]
            ]),
            "desc": [2, 2, 2, 2],
            "k": 1,
            "expected": 1.0,
        },
        # ç”¨ä¾‹ 3ï¼šè¶…é‡å­å…³è”ï¼ˆè¿å Tsirelson ç•Œï¼ŒK=1 å±‚çº§ä¸å¯è¡Œï¼‰
        {
            "name": "CHSH è¶…é‡å­å…³è”ï¼ˆK=1ï¼‰",
            "cg": np.array([
                [1.0, 0.5, 0.5],
                [0.5, 0.9, 0.1],  # è”åˆæ¦‚ç‡è¶…å‡ºé‡å­ç•Œï¼ˆæœ€å¤§é‡å­å€¼ä¸º 0.75ï¼‰
                [0.5, 0.1, 0.9]
            ]),
            "desc": [2, 2, 2, 2],
            "k": 1,
            "expected": 0.0,  # é¢„æœŸè¿”å› 0ï¼ˆä¸æ»¡è¶³ï¼‰
        },
        # ç”¨ä¾‹ 4ï¼šè¾¹ç•Œæƒ…å†µï¼ˆæ— æµ‹é‡è®¾ç½®ï¼ŒMA=0, MB=0ï¼Œä»…å•ä½ç®—å­ï¼‰
        {
            "name": "æ— æµ‹é‡è®¾ç½®ï¼ˆK=1ï¼‰",
            "cg": np.array([[1.0]]),  # ä»…å½’ä¸€åŒ–é¡¹ï¼ˆå•ä½ç®—å­æœŸæœ›å€¼ï¼‰
            "desc": [2, 2, 0, 0],  # MA=0, MB=0ï¼šæ— æµ‹é‡ï¼Œä»…å•ä½ç®—å­
            "k": 1,
            "expected": 1.0,  # é¢„æœŸè¿”å› 1ï¼ˆä»…å•ä½ç®—å­ï¼Œæ»¡è¶³åŠæ­£å®šï¼‰
        },
        # ç”¨ä¾‹ 5ï¼šå­—ç¬¦ä¸²æ ¼å¼å±‚çº§ï¼ˆK='1+ab'ï¼Œç»å…¸å…³è”å¯è¡Œï¼‰
        {
            "name": "ç»å…¸å…³è”ï¼ˆK='1+ab'ï¼‰",
            "cg": np.array([
                [0, 0, 0],
                [0, 1, 1],
                [0, 1, -1]
            ]),
            "desc": [2, 2, 2, 2],
            "k": "1+ab",  # å­—ç¬¦ä¸²æ ¼å¼å±‚çº§
            "expected": 1.0,
        },
    ]

    # æ‰§è¡Œæµ‹è¯•
    passed = 0
    for case in test_cases:
        print(f"\n{'=' * 50}")
        print(f"æµ‹è¯•ç”¨ä¾‹ï¼š{case['name']}")
        print(f"è¾“å…¥å‚æ•°ï¼šdesc={case['desc']}, k={case['k']}")
        print(f"å…³è”çŸ©é˜µ CGï¼š\n{case['cg']}")

        try:
            # è°ƒç”¨ NPA å‡½æ•°
            result = NPAHierarchy(case['cg'], case['desc'], case['k'])
            print(f"å®é™…è¾“å‡ºï¼š{result}")
            print(f"é¢„æœŸè¾“å‡ºï¼š{case['expected']}")

            # éªŒè¯ç»“æœï¼ˆå…è®¸å¾®å°æ•°å€¼è¯¯å·®ï¼Œå› æ±‚è§£å™¨ç²¾åº¦ï¼‰
            if np.isclose(result, case['expected'], atol=1e-3):
                print("æµ‹è¯•ç»“æœï¼šâœ… é€šè¿‡")
                passed += 1
            else:
                print("æµ‹è¯•ç»“æœï¼šâŒ å¤±è´¥ï¼ˆç»“æœä¸åŒ¹é…ï¼‰")
        except Exception as e:
            print(f"æµ‹è¯•ç»“æœï¼šâŒ å¤±è´¥ï¼ˆæŠ¥é”™ï¼š{str(e)}ï¼‰")

    # è¾“å‡ºæµ‹è¯•æ€»ç»“
    print(f"\n{'=' * 50}")
    print(f"æµ‹è¯•æ€»ç»“ï¼šå…± {len(test_cases)} ä¸ªç”¨ä¾‹ï¼Œé€šè¿‡ {passed} ä¸ªï¼Œå¤±è´¥ {len(test_cases) - passed} ä¸ª")
    if passed == len(test_cases):
        print("ğŸ‰ æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹é€šè¿‡ï¼å‡½æ•°æ­£å¸¸è¿è¡Œã€‚")
    else:
        print("âš ï¸  éƒ¨åˆ†æµ‹è¯•ç”¨ä¾‹å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä»£ç é€»è¾‘æˆ–å‚æ•°è®¾ç½®ã€‚")


if __name__ == "__main__":
    test_npa_hierarchy()